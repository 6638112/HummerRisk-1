<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hummerrisk.base.mapper.ext.ExtCloudEventMapper">

  <resultMap id="BaseResultMap" type="com.hummerrisk.base.domain.CloudEvent">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Sun Aug 28 16:19:28 CST 2022.
    -->
    <result column="event_id" jdbcType="VARCHAR" property="eventId" />
    <result column="cloud_account_id" jdbcType="VARCHAR" property="cloudAccountId" />
    <result column="sync_region" jdbcType="VARCHAR" property="syncRegion" />
    <result column="acs_region" jdbcType="VARCHAR" property="acsRegion" />
    <result column="event_name" jdbcType="VARCHAR" property="eventName" />
    <result column="event_type" jdbcType="VARCHAR" property="eventType" />
    <result column="event_category" jdbcType="VARCHAR" property="eventCategory" />
    <result column="event_version" jdbcType="VARCHAR" property="eventVersion" />
    <result column="event_rw" jdbcType="VARCHAR" property="eventRw" />
    <result column="event_message" jdbcType="VARCHAR" property="eventMessage" />
    <result column="event_source" jdbcType="VARCHAR" property="eventSource" />
    <result column="event_time" jdbcType="TIMESTAMP" property="eventTime" />
    <result column="source_ip_address" jdbcType="VARCHAR" property="sourceIpAddress" />
    <result column="user_agent" jdbcType="VARCHAR" property="userAgent" />
    <result column="user_identity" jdbcType="VARCHAR" property="userIdentity" />
    <result column="service_name" jdbcType="VARCHAR" property="serviceName" />
    <result column="additional_event_data" jdbcType="VARCHAR" property="additionalEventData" />
    <result column="request_id" jdbcType="VARCHAR" property="requestId" />
    <result column="request_parameters" jdbcType="VARCHAR" property="requestParameters" />
    <result column="resource_type" jdbcType="VARCHAR" property="resourceType" />
    <result column="resource_name" jdbcType="VARCHAR" property="resourceName" />
    <result column="referenced_resources" jdbcType="VARCHAR" property="referencedResources" />
    <result column="api_version" jdbcType="VARCHAR" property="apiVersion" />
    <result column="response_elements" jdbcType="VARCHAR" property="responseElements" />
    <result column="user_name" jdbcType="VARCHAR" property="userName" />
  </resultMap>

  <sql id="condition">
    <choose>
      <when test='${object}.operator == "like"'>
        like CONCAT('%', #{${object}.value},'%')
      </when>
      <when test='${object}.operator == "not like"'>
        not like CONCAT('%', #{${object}.value},'%')
      </when>
      <when test='${object}.operator == "in"'>
        in
        <foreach collection="${object}.value" item="v" separator="," open="(" close=")">
          #{v}
        </foreach>
      </when>
      <when test='${object}.operator == "not in"'>
        not in
        <foreach collection="${object}.value" item="v" separator="," open="(" close=")">
          #{v}
        </foreach>
      </when>
      <when test='${object}.operator == "between"'>
        between #{${object}.value[0]} and #{${object}.value[1]}
      </when>
      <when test='${object}.operator == "gt"'>
        &gt; #{${object}.value}
      </when>
      <when test='${object}.operator == "lt"'>
        &lt; #{${object}.value}
      </when>
      <when test='${object}.operator == "ge"'>
        &gt;= #{${object}.value}
      </when>
      <when test='${object}.operator == "le"'>
        &lt;= #{${object}.value}
      </when>
      <otherwise>
        = #{${object}.value}
      </otherwise>
    </choose>
  </sql>

  <sql id="combine">
    <if test='${condition}.accountId != null'>
      and t.cloud_account_id
      <include refid="condition">
        <property name="object" value="${condition}.accountId"/>
      </include>
    </if>
    <if test="${condition}.region != null">
      and t.sync_region
      <include refid="condition">
        <property name="object" value="${condition}.region"/>
      </include>
    </if>
    <if test="${condition}.eventTime != null">
      and t.event_time
      <include refid="condition">
        <property name="object" value="${condition}.eventTime"/>
      </include>
    </if>
    <if test="${condition}.userName != null">
      and t.user_name
      <include refid="condition">
        <property name="object" value="${condition}.userName"/>
      </include>
    </if>
    <if test="${condition}.eventName != null">
      and t.event_name
      <include refid="condition">
        <property name="object" value="${condition}.eventName"/>
      </include>
    </if>
    <if test="${condition}.resourceType != null">
      and t.resource_type
      <include refid="condition">
        <property name="object" value="${condition}.resourceType"/>
      </include>
    </if>
    <if test='${condition}.resourceName != null'>
      and t.resource_name
      <include refid="condition">
        <property name="object" value="${condition}.resourceName"/>
      </include>
    </if>
  </sql>

  <select id="getCloudEventList" resultMap="BaseResultMap">
    select  t.event_id, t.cloud_account_id, t.sync_region, t.acs_region, t.event_name, t.event_type, t.event_category,
    t.event_version, t.event_rw, t.event_message, t.event_source, t.event_time, t.source_ip_address,
    t.user_agent, t.user_identity, t.service_name, t.additional_event_data, t.request_id, t.request_parameters,
    t.resource_type, t.resource_name, t.referenced_resources, t.api_version, t.response_elements,
    t.user_name from cloud_event t
    where
    1=1
    <if test="request.combine != null">
      <include refid="combine">
        <property name="condition" value="request.combine"/>
        <property name="name" value="request.name"/>
      </include>
    </if>
    <if test="request.name != null and request.name != ''">
      and t.event_name like CONCAT('%', #{request.name},'%')
    </if>
    order by event_time desc

  </select>

  <insert id="batchCloudEvents">
    insert into cloud_event(event_id, sync_region, acs_region,
    event_name, event_type, event_category,
    event_version, event_rw, event_message,
    event_source, event_time, source_ip_address,
    user_agent, user_identity, service_name,
    additional_event_data, request_id, request_parameters,
    resource_type, resource_name, referenced_resources,
    api_version, response_elements, cloud_account_id,user_name
    ) values
    <foreach item="item" index="index" collection="list" separator=",">
      (#{item.eventId,jdbcType=VARCHAR}, #{item.syncRegion,jdbcType=VARCHAR}, #{item.acsRegion,jdbcType=VARCHAR},
      #{item.eventName,jdbcType=VARCHAR}, #{item.eventType,jdbcType=VARCHAR}, #{item.eventCategory,jdbcType=VARCHAR},
      #{item.eventVersion,jdbcType=VARCHAR}, #{item.eventRw,jdbcType=VARCHAR}, #{item.eventMessage,jdbcType=VARCHAR},
      #{item.eventSource,jdbcType=VARCHAR}, #{item.eventTime,jdbcType=TIMESTAMP}, #{item.sourceIpAddress,jdbcType=VARCHAR},
      #{item.userAgent,jdbcType=VARCHAR}, #{item.userIdentity,jdbcType=VARCHAR}, #{item.serviceName,jdbcType=VARCHAR},
      #{item.additionalEventData,jdbcType=VARCHAR}, #{item.requestId,jdbcType=VARCHAR}, #{item.requestParameters,jdbcType=VARCHAR},
      #{item.resourceType,jdbcType=VARCHAR}, #{item.resourceName,jdbcType=VARCHAR}, #{item.referencedResources,jdbcType=VARCHAR},
      #{item.apiVersion,jdbcType=VARCHAR}, #{item.responseElements,jdbcType=VARCHAR}, #{item.cloudAccountId,jdbcType=VARCHAR}
      , #{item.userName,jdbcType=VARCHAR}
      )
    </foreach>
  </insert>


</mapper>